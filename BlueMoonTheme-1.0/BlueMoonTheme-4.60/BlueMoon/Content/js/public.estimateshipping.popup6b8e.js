function createEstimateShippingPopUp(n){return{settings:$.extend({},{opener:!1,form:!1,requestDelay:300,urlFactory:!1,handlers:{},localizedData:!1,contentEl:!1,countryEl:!1,stateProvinceEl:!1,zipPostalCodeEl:!1,useCity:!1,cityEl:!1,errorMessageBoxClass:"message-failure"},n),params:{jqXHR:!1,displayErrors:!1,delayTimer:!1,selectedShippingOption:!1},init:function(){var n=this,t=$(this.settings.contentEl),i;$(".apply-shipping-button",t).on("click",function(){var t=n.getActiveShippingOption();t&&t.provider&&t.price&&(n.selectShippingOption(t),n.closePopup())});$(this.settings.opener).magnificPopup({type:"inline",removalDelay:500,callbacks:{beforeOpen:function(){this.st.mainClass=this.st.el.attr("data-effect")},open:function(){n.settings.handlers.openPopUp&&n.settings.handlers.openPopUp();n.params.displayErrors=!0}}});i=function(){n.clearShippingOptions();var t=n.getShippingAddress();n.getShippingOptions(t)};$(this.settings.countryEl,t).on("change",function(){$(n.settings.stateProvinceEl,t).val(0);i()});$(this.settings.stateProvinceEl,t).on("change",i);if(this.settings.useCity)$(this.settings.cityEl,t).on("input propertychange paste",i);else $(this.settings.zipPostalCodeEl,t).on("input propertychange paste",i)},closePopup:function(){$.magnificPopup.close()},getShippingOptions:function(n){if(this.validateAddress(n)){var t=this;t.setLoadWaiting();t.settings.handlers.load&&t.settings.handlers.load();clearTimeout(t.params.delayTimer);t.params.delayTimer=setTimeout(function(){t.params.jqXHR&&t.params.jqXHR.readyState!==4&&t.params.jqXHR.abort();var i=t.settings.urlFactory(n);i&&(t.params.jqXHR=$.ajax({cache:!1,url:i,data:$(t.settings.form).serialize(),type:"POST",success:function(i){t.successHandler(n,i)},error:function(n,i,r){t.errorHandler(n,i,r)},complete:function(n,i){t.settings.handlers.complete&&t.settings.handlers.complete(n,i)}}))},t.settings.requestDelay)}},setLoadWaiting:function(){this.clearErrorMessage();$(".shipping-options-body",$(this.settings.contentEl)).html($("<div/>").addClass("shipping-options-loading"))},successHandler:function(n,t){var u,i,f,r;$(".shipping-options-body",$(this.settings.contentEl)).empty();t.Success?(i=t.ShippingOptions,i&&i.length>0?(f=this,r=this.params.selectedShippingOption,$.each(i,function(t,i){(i.Selected||r&&r.provider===i.Name&&f.addressesAreEqual(r.address,n))&&(u={provider:i.Name,price:i.Price,address:n,deliveryDate:i.DeliveryDateFormat});f.addShippingOption(i.Name,i.DeliveryDateFormat,i.Price)}),u||(u={provider:i[0].Name,price:i[0].Price,deliveryDate:i[0].DeliveryDateFormat,address:n}),!$.magnificPopup.instance.isOpen&&r&&this.addressesAreEqual(r.address,n)&&this.selectShippingOption(u),this.setActiveShippingOption(u)):this.clearShippingOptions()):(this.params.displayErrors=!0,this.clearErrorMessage(),this.clearShippingOptions(),this.showErrorMessage(t.Errors));this.settings.handlers.success&&this.settings.handlers.success(n,t)},errorHandler:function(n,t,i){t!=="abort"&&(this.clearShippingOptions(),this.settings.handlers.error&&this.settings.handlers.error(n,t,i))},clearErrorMessage:function(){$("."+this.settings.errorMessageBoxClass,$(this.settings.contentEl)).empty()},showErrorMessage:function(n){if(this.params.displayErrors){var t=$("."+this.settings.errorMessageBoxClass,$(this.settings.contentEl));$.each(n,function(n,i){t.append($("<div/>").text(i))})}},selectShippingOption:function(n){n&&n.provider&&n.price&&this.validateAddress(n.address)&&(this.params.selectedShippingOption=n);this.settings.handlers.selectedOption&&this.settings.handlers.selectedOption(n)},addShippingOption:function(n,t,i){var r,u;if(n&&i){r=$("<div/>").addClass("estimate-shipping-row shipping-option");r.append($("<div/>").addClass("estimate-shipping-row-item-radio").append($("<input/>").addClass("estimate-shipping-radio").attr({type:"radio",name:"shipping-option-"+this.settings.contentEl})).append($("<label/>"))).append($("<div/>").addClass("estimate-shipping-row-item shipping-item").text(n)).append($("<div/>").addClass("estimate-shipping-row-item shipping-item").text(t?t:"-")).append($("<div/>").addClass("estimate-shipping-row-item shipping-item").text(i));u=this;r.on("click",function(){$('input[name="shipping-option-'+u.settings.contentEl+'"]',$(this)).prop("checked",!0);$(".shipping-option.active",$(u.settings.contentEl)).removeClass("active");$(this).addClass("active")});$(".shipping-options-body",$(this.settings.contentEl)).append(r)}},clearShippingOptions:function(){var n=this.settings.localizedData.noShippingOptionsMessage;$(".shipping-options-body",$(this.settings.contentEl)).html($("<div/>").addClass("no-shipping-options").text(n))},setActiveShippingOption:function(n){$.each($(".shipping-option",$(this.settings.contentEl)),function(t,i){var r=$(".shipping-item",i),u=r.eq(0).text().trim(),f=r.eq(2).text().trim();if(u===n.provider&&f===n.price){$(i).trigger("click");return}})},getActiveShippingOption:function(){var n=$(".shipping-item",$(".shipping-option.active",$(this.settings.contentEl)));return{provider:n.eq(0).text().trim(),deliveryDate:n.eq(1).text().trim(),price:n.eq(2).text().trim(),address:this.getShippingAddress()}},getShippingAddress:function(){var n={},t=$(this.settings.contentEl),i=$(this.settings.countryEl,t).find(":selected"),r=$(this.settings.stateProvinceEl,t).find(":selected"),u=$(this.settings.zipPostalCodeEl,t),f=$(this.settings.cityEl,t);return i&&i.val()>0&&(n.countryId=i.val(),n.countryName=i.text()),r&&r.val()>0&&(n.stateProvinceId=r.val(),n.stateProvinceName=r.text()),u&&u.val()&&(n.zipPostalCode=u.val()),f&&f.val()&&(n.city=f.val()),n},addressesAreEqual:function(n,t){return n.countryId===t.countryId&&n.stateProvinceId===t.stateProvinceId&&(this.settings.useCity||n.zipPostalCode===t.zipPostalCode)&&(!this.settings.useCity||n.city===t.city)},validateAddress:function(n){this.clearErrorMessage();var t=[],i=this.settings.localizedData;return n.countryName&&n.countryId>0||t.push(i.countryErrorMessage),this.settings.useCity&&!n.city&&t.push(i.cityErrorMessage),this.settings.useCity||n.zipPostalCode||t.push(i.zipPostalCodeErrorMessage),t.length>0&&this.showErrorMessage(t),t.length===0}}}